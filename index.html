<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <script>
  
    window.onload = function() {
      try {
        //failure can be exception, or null
        console.log("Checking for params");
        const urlParams = new URLSearchParams(window.location.search);

        var simulate = urlParams.get('simulate')=='true';



        console.log(`simulate: ${simulate}`);

        var params = JSON.parse(atob(urlParams.get('params')));

        if (null == params) {
          throw "Combo parse failed.";
        } else {
          console.log("Successfully parsed encoded params");
        }
      } catch (e) {
        console.log("Combo failed. Dropping through to individual params");
        var params = {
          lat: parseFloat(urlParams.get('lat')),
          lon: parseFloat(urlParams.get('lon')),
          alt: parseFloat(urlParams.get('alt'))
        };
      }

      console.log("using the following params:");
      console.log(params);

      var sceneEl = document.querySelector('a-scene');

      console.log("adding location to scene");
      if (params.lon != null && params.lon != null) {
        var loc = `latitude: ${params.lat}; longitude: ${params.lon};`;
        console.log(`substituting coordinates: ${loc}`);
        var gps = document.createAttribute("gps-projected-entity-place");
        gps.value  = loc;
        sceneEl.setAttributeNode(gps);

        if(simulate){
          var cameraEl = sceneEl.querySelector('a-camera');
          cameraEl.setAttribute('simulateLatitude', params.lat);
          cameraEl.setAttribute('simulateLongitude', params.lon);
        }

      } else {
        console.log("No coordinates found.");
      }

      console.log(`substituting altitude: ${params.alt}`);
      var containerEls = sceneEl.querySelectorAll(".scene-container");

      containerEls.forEach(function (el) {
        var pos = el.getAttribute("position");

        pos.y = pos.y + params.alt;
        console.log(pos);

        el.setAttribute("position", pos);
      });
    }
</script>


</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene 
    fog="type: linear; color: #AAA" 
    renderer="logarithmicDepthBuffer: true;"
    embedded 
    loading-screen="enabled: true;" 
    arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
      <a-asset-item id="model-asset" src="./assets/model.glb" />
      <a-asset-item id="sound-asset" src="./assets/market.mp3"></a-asset-item>
    </a-assets>

    <a-entity 
      class="scene-container" 
      sound="src: #sound-asset; autoplay=true"
      geometry="primitive: box; width: 4; height: 8 ; depth: 2"
      material="shader: flat; color: red; transparent: true; opacity: 0.0" 
      position="0 2 -5" 
      rotation="0 0 0">

      <a-entity 
        id="santa"
        gltf-model="#model" 
        scale="1 1 1" 
        position="0 0 0" 
        rotation="0 0 0">
      </a-entity>


    </a-entity>

    <a-camera gps-projected-camera read-rotation><a-cursor></a-cursor></a-camera>
  </a-scene>
</body>

</html>