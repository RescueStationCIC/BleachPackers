<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js" ></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js" ></script>
  
  <script>

    function processParams(){
      try {
        //failure can be exception, or null
        console.log("Checking for params");
        const urlParams = new URLSearchParams(window.location.search);

        var simulate = urlParams.get('simulate')=='true';

        console.log(`simulate: ${simulate}`);

        var params = JSON.parse(atob(urlParams.get('params')));

        if (null == params) {
          throw "Combo parse failed.";
        } else {
          console.log("Successfully parsed encoded params");
        }
      } catch (e) {
        console.log("Combo failed. Dropping through to individual params");
        var params = {
          lat: parseFloat(urlParams.get('lat')),
          lon: parseFloat(urlParams.get('lon')),
          alt: parseFloat(urlParams.get('alt')),
          scale: parseFloat(urlParams.get('scale')),
        };
      }
      params.simulate = simulate;

      console.log("using the following params:");
      console.log(params);
      return params;
    }

    //THANKYOU: https://stackoverflow.com/a/61443888
    function changeReadOnlyLocations(params){
      var sceneEl = document.querySelector('a-scene');
      var el = sceneEl.querySelector("#model");

      console.log("processing location");

      if (params.lon != null && params.lon != null) {
        var loc = `latitude: ${params.lat}; longitude: ${params.lon};`;
        
        console.log(`substituting coordinates: ${loc}`);
        var gps = document.createAttribute("gps-projected-entity-place");
        gps.value  = loc;
        el.setAttributeNode(gps);

        if(params.simulate){
          console.log('simulating location');
          var cameraEl = sceneEl.querySelector('a-camera');
          cameraEl.setAttribute('simulateLatitude', params.lat);
          cameraEl.setAttribute('simulateLongitude', params.lon);
        }

      } else {
        console.log("No coordinates found.");
      }
    }

    window.onload = function() {
      var params = processParams();
      changeReadOnlyLocations(params);
      window.reallyHackyGlobalLocation = params;
      addModelToScene();
    }

</script>

<script>
  AFRAME.registerComponent('scalechanger', {
  init: function () {
    var params = window.reallyHackyGlobalLocation;
    
    if(params.scale != null){
      this.el.setAttribute('scale',{x:params.scale, y:params.scale, z:params.scale}, true);
      }else{
        console.log("no scale found.");
      }
  }
});
</script>

<script>
  AFRAME.registerComponent('positionchanger', {
  init: function () {
    var params = window.reallyHackyGlobalLocation;
    if(params.alt != null){
      var pos = this.el.getAttribute('position');
      this.el.setAttribute('position',{x:pos.x, y:params.alt, z:pos.z},true);
      }else{
        console.log("no position found.");
      }
  }
});
</script>



</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene 
    fog="type: linear; color: #AAA" 
    renderer="logarithmicDepthBuffer: true;"
    embedded 
    loading-screen="enabled: true;" 
    arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets  timeout="10000">
      <a-asset-item id="model-asset" src="./assets/model.glb" />
      <a-asset-item id="sound-asset" src="./assets/market.mp3"></a-asset-item>
    </a-assets>

    <a-entity 
      id="model"
  
      gltf-model="#model-asset"
      scalechanger
      positionchanger 
      scale="1 1 1" 
      position="0 0 0" 
      rotation="0 0 0">
    </a-entity>

    <a-camera gps-projected-camera read-rotation><a-cursor></a-cursor></a-camera>
  </a-scene>
</body>

</html>